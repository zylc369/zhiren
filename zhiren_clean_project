#!/bin/bash

# -e: å‘½ä»¤å¤±è´¥æ—¶ç«‹å³é€€å‡º
# -u: ä½¿ç”¨æœªå®šä¹‰å˜é‡æ—¶æŠ¥é”™
set -euo pipefail

SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"

dir_detect() {
    local log_color_red="\033[0;31m"
    local nc="\033[0m"
    # æ£€æŸ¥å½“å‰ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨ .zhiren æ–‡ä»¶å¤¹
    if [[ ! -d ".zhiren" || ! -d "specs" || ! -f "TASKS.md" || ! -f "CONTEXT.md" ]]; then
        echo -e "${log_color_red}å¿…é¡»è¦åŒæ—¶æœ‰ .zhirenã€specsã€TASKS.mdã€CONTEXT.mdï¼Œè¿™äº›ç›®å½•æˆ–æ–‡ä»¶è¡¨æ˜æ­¤å¤„ä½¿ç”¨äº† zhiren AI å·¥å…·ã€‚æ¸…ç†å…¶ä»–ç›®å½•å±éæ³•æ“ä½œã€‚${nc}"
        exit 1
    fi
}
dir_detect

# Source library components
source "$SCRIPT_DIR/lib/tools.sh"
source "$SCRIPT_DIR/lib/consts.sh"
source "$SCRIPT_DIR/lib/log.sh"

usage() {
    cat <<EOF
ç”¨æ³•: $0 [é€‰é¡¹] <ç›®æ ‡ç›®å½•>

é€‰é¡¹:
  -k, --keep ITEM      æŒ‡å®šè¦ä¿ç•™çš„æ–‡ä»¶æˆ–ç›®å½•ï¼ˆå¯å¤šæ¬¡ä½¿ç”¨ï¼‰
  --all                æ˜¾å¼è¡¨ç¤ºæ¸…ç†æ‰€æœ‰å†…å®¹ï¼ˆä¸ä¿ç•™ä»»ä½•ä¸œè¥¿ï¼‰
  -h, --help           æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

æ³¨æ„ï¼š
  - å¿…é¡»æ˜¾å¼æŒ‡å®š --all æˆ–è‡³å°‘ä¸€ä¸ª --keepï¼Œå¦åˆ™è„šæœ¬æ‹’ç»è¿è¡Œã€‚
  - ç›®æ ‡ç›®å½•æœ¬èº«ä¸ä¼šè¢«åˆ é™¤ï¼Œåªæ¸…ç†å…¶å†…å®¹ã€‚
EOF
}

# åˆå§‹åŒ–å˜é‡
declare -a KEEP_ITEMS=()
CLEAN_ALL=false
CONFIRM_TO_YES=false
TARGET_DIR=$(pwd)

# è§£æå‚æ•°ï¼ˆå…¼å®¹ bash-3.2ï¼Œä¸ä½¿ç”¨ getopts é•¿é€‰é¡¹ï¼‰
while [ $# -gt 0 ]; do
    case "$1" in
        -k|--keep)
            if [ -z "$2" ]; then
                echo "é”™è¯¯: '$1' éœ€è¦ä¸€ä¸ªå‚æ•°" >&2
                exit 1
            fi
            KEEP_ITEMS+=("$2")
            shift 2
            ;;
        -a|--all)
            CLEAN_ALL=true
            shift
            ;;
        -y|--yes)
            CONFIRM_TO_YES=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*|*)
            log "ERROR" "æœªçŸ¥é€‰é¡¹: $1" >&2
            usage >&2
            exit 1
            ;;
    esac
done

log "INFO" "ğŸš€ å¼€å§‹æ¸…ç†å½“å‰ç›®å½•"
log "INFO" ""

# æ£€æŸ¥å‚æ•°é€»è¾‘ï¼šå¿…é¡»æ˜¾å¼æŒ‡å®š --all æˆ–è‡³å°‘ä¸€ä¸ª --keep
if [ "$CLEAN_ALL" = false ] && [ ${#KEEP_ITEMS[@]} -eq 0 ]; then
    log "ERROR" "å¿…é¡»æŒ‡å®š --allï¼ˆæ¸…ç†å…¨éƒ¨ï¼‰æˆ–è‡³å°‘ä¸€ä¸ª --keepï¼ˆä¿ç•™é¡¹ï¼‰" >&2
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦æŒ‡å®šäº†ç›®æ ‡ç›®å½•
if [ -z "$TARGET_DIR" ]; then
    log "ERROR" "æœªæŒ‡å®šç›®æ ‡ç›®å½•" >&2
    usage >&2
    exit 1
fi

# æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
if [ ! -d "$TARGET_DIR" ]; then
    log "ERROR" "ç›®æ ‡ä¸æ˜¯æœ‰æ•ˆç›®å½•: $TARGET_DIR" >&2
    exit 1
fi

# è¿›å…¥ç›®æ ‡ç›®å½•ï¼ˆé¿å…è·¯å¾„æ‹¼æ¥é—®é¢˜ï¼‰
cd "$TARGET_DIR"

# ä½¿ç”¨ find å‘½ä»¤è·å–æ‰€æœ‰ééšè—é¡¹
mapfile -t ALL_ITEMS < <(find . -maxdepth 1 -name "[!.]*" -print 2>/dev/null)
# å»é™¤å¼€å¤´çš„ "./"
ALL_ITEMS=("${ALL_ITEMS[@]#./}")

# å¦‚æœç›®å½•ä¸ºç©ºï¼Œç›´æ¥é€€å‡º
if [ ${#ALL_ITEMS[@]} -eq 0 ]; then
    log "SUCCESS" "ç›®å½•ä¸ºç©ºï¼Œæ— éœ€æ¸…ç†ã€‚"
    exit 0
fi

# æ„å»ºè¦åˆ é™¤çš„åˆ—è¡¨
declare -a TO_DELETE=()

for item in "${ALL_ITEMS[@]}"; do
    should_keep=false
    for keep in "${KEEP_ITEMS[@]}"; do
        if [ "$item" = "$keep" ]; then
            should_keep=true
            break
        fi
    done
    if [ "$should_keep" = false ]; then
        TO_DELETE+=("$item")
    fi
done

# å¦‚æœ --all æ¨¡å¼ï¼ŒTO_DELETE åº”ç­‰äº ALL_ITEMS
if [ "$CLEAN_ALL" = true ]; then
    TO_DELETE=("${ALL_ITEMS[@]}")
fi

# å¦‚æœæ²¡æœ‰è¦åˆ é™¤çš„ï¼Œæç¤ºå¹¶é€€å‡º
if [ ${#TO_DELETE[@]} -eq 0 ]; then
    log "SUCCESS" "æ²¡æœ‰éœ€è¦æ¸…ç†çš„å†…å®¹ã€‚"
    exit 0
fi

delete_files() {
    # ä½¿ç”¨ rm -rf åˆ é™¤æ¯ä¸ªé¡¹ç›®
    for del in "${TO_DELETE[@]}"; do
        rm -rf -- "$del"
    done
    log "SUCCESS" "æ¸…ç†å®Œæˆã€‚"
}

if [[ "$CONFIRM_TO_YES" == "true" ]]; then
    delete_files
    exit 0
fi

# æ‰§è¡Œåˆ é™¤
log "INFO" "å³å°†åˆ é™¤ä»¥ä¸‹å†…å®¹ï¼ˆä½äº: $TARGET_DIRï¼‰:"
printf '  %s\n' "${TO_DELETE[@]}"
echo -n "ç¡®è®¤åˆ é™¤? (y/N): "
read -r confirm

if [[ "$confirm" =~ ^[Yy]$ ]]; then
    delete_files
else
    log "WARN" "æ“ä½œå·²å–æ¶ˆã€‚"
    exit 0
fi