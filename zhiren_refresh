#!/bin/bash

# -e: ÂëΩ‰ª§Â§±Ë¥•Êó∂Á´ãÂç≥ÈÄÄÂá∫
# -u: ‰ΩøÁî®Êú™ÂÆö‰πâÂèòÈáèÊó∂Êä•Èîô
set -eu

SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"

# Âú∫ÊôØ
export ZHIREN_EXECUTE_SCENE="refresh"

# sessionÁõ∏ÂÖ≥ÂèòÈáè
ZHIREN_CLAUDE_SESSION_IS_NEW="true"
ZHIREN_CLAUDE_SESSION_ID=$(uuidgen)

# Instance-specific temp folder for verbose command output
# Uses PID + timestamp for uniqueness across concurrent instances
ZHIREN_INSTANCE_ID="$$_$(date +%s)"
ZHIREN_TMP_DIR="/tmp/zhiren-${ZHIREN_EXECUTE_SCENE}-${ZHIREN_INSTANCE_ID}"
export ZHIREN_TMP_DIR

# Source library components
source "$SCRIPT_DIR/lib/tools.sh"
source "$SCRIPT_DIR/lib/consts.sh"
source "$SCRIPT_DIR/lib/date_utils.sh"
source "$SCRIPT_DIR/lib/log.sh"
source "$SCRIPT_DIR/lib/prompts.sh"
source "$SCRIPT_DIR/lib/task_manager.sh"
source "$SCRIPT_DIR/lib/safe_mode.sh"
source "$SCRIPT_DIR/lib/claude.sh"

log "LIGHT" "üöÄ Starting Zhiren refresh tasks script..."
log "INFO" "ZHIREN_EXECUTE_SCENE=$ZHIREN_EXECUTE_SCENE"
log "INFO" "SCRIPT_DIR=$SCRIPT_DIR"
log "INFO" "ZHIREN_HOME=$ZHIREN_HOME"
log "INFO" "ZHIREN_PROJECT_ROOT=$ZHIREN_PROJECT_ROOT"
log "INFO" "LOG_DIR=$LOG_DIR"
log "INFO" "LOG_FILE=$LOG_FILE"
log "INFO" "ZHIREN_TMP_DIR=$ZHIREN_TMP_DIR"
log "INFO" "ZHIREN_CLAUDE_SESSION_IS_NEW=$ZHIREN_CLAUDE_SESSION_IS_NEW"
log "INFO" "ZHIREN_CLAUDE_SESSION_ID=$ZHIREN_CLAUDE_SESSION_ID"
log "INFO" ""

refresh_tasks() {
    local notes_file="$1"

    if [[ -z "$notes_file" ]]; then
        log "ERROR" "Usage: zhiren-refresh <notes.md>"
        exit 1
    fi

    if [[ ! -f "$notes_file" ]]; then
        log "ERROR" "Error: file '$notes_file' not found"
        exit 1
    fi

    if [[ ! -f "$CONTEXT_FILE" ]]; then
        log "ERROR" "Error: file '$CONTEXT_FILE' not found - run 'zhiren init' first"
        exit 1
    fi

    if [[ ! -f "$TASK_FILE" ]]; then
        log "ERROR" "Error: file '$TASK_FILE' not found - run 'zhiren init' first"
        exit 1
    fi

    log "LIGHT" "Zhiren refreshing project from: $notes_file"

    local refresh_prompt=$(cat "${SCRIPT_DIR}/resources/prompt_refresh.md")

    local notes_content=$(cat "$notes_file")
    local context_content=$(cat "$CONTEXT_FILE")
    local tasks_content=$(cat "$TASK_FILE")

    local user_prompt="# USER'S NOTES:

$notes_content

---

## CURRENT CONTEXT.md:
$context_content

---

## CURRENT TASKS.md:
$tasks_content"

    # Read CLAUDE.md if exists
    local CLAUDE_MD=""
    if [[ -f "CLAUDE.md" ]]; then
        CLAUDE_MD="## Project Rules (from CLAUDE.md):
\`\`\`markdown
$(cat CLAUDE.md)
\`\`\`
"
        user_prompt="$user_prompt

---

$CLAUDE_MD"
    fi

    user_prompt="$user_prompt

---

$refresh_prompt"

    local zhiren_step="REFRESH"
    run_claude "user_prompt" "$user_prompt" \
        "phase" "$zhiren_step" \
        "session_is_new" "true" \
        "session_id" "$ZHIREN_CLAUDE_SESSION_ID" \
        "save_mode" "false"
    local claude_exit_code=$?
    if [[ ! $claude_exit_code -eq 0 ]]; then
        log "ERROR" "[$zhiren_step] Claude failed, exit code $claude_exit_code"
        exit $claude_exit_code
    fi

    # Show result
    local new_tasks=$(grep -c '^\s*- \[ \]' "$TASK_FILE" | xargs 2>/dev/null || echo "0")
    log "SUCCESS" "Project refreshed!"
    log "INFO" "  - $new_tasks pending tasks in $TASK_FILE"
    log "INFO" ""
    log "LIGHT" "Run 'zhiren' to work through the new tasks"
}

NOTES_FILE="${1:-}"
refresh_tasks "$NOTES_FILE"