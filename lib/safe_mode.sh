#!/bin/bash

# -e: 命令失败时立即退出
# -u: 使用未定义变量时报错
set -eu

SAFE_MODE_DOCKERFILE="$PROJECT_ZHIREN_DIR/Dockerfile"

#==============================================================================
# SAFE MODE FUNCTIONS
#==============================================================================

# Generate image name from current directory
SAFE_MODE_PROJECT_NAME=$(basename "$(pwd)" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')
SAFE_MODE_IMAGE_NAME="zhiren-${SAFE_MODE_PROJECT_NAME}"

# Detect if project uses safe mode
detect_safe_mode() {
    if [[ -f "$SAFE_MODE_DOCKERFILE" ]]; then
        # Check if Docker is available
        if ! command -v docker &>/dev/null; then
            echo -e "${RED}Error: Docker required for safe mode but not found${LOG_COLOR_NC}"
            exit 1
        fi

        # Check if credentials exist
        if [[ ! -f "$HOME/.claude/.credentials.json" ]]; then
            echo -e "${RED}Error: Claude credentials not found at ~/.claude/.credentials.json${LOG_COLOR_NC}"
            echo -e "Run 'claude' on the host first to authenticate"
            exit 1
        fi

        echo "true"
    fi

    echo "false"
}

# Build Docker image if needed
build_docker_image() {
    local force_rebuild="$1"

    if [[ "$force_rebuild" == "true" ]] || ! docker image inspect "$SAFE_MODE_IMAGE_NAME" &>/dev/null 2>&1; then
        echo -e "${CYAN}Building Docker image: $SAFE_MODE_IMAGE_NAME${LOG_COLOR_NC}"
        docker build -t "$SAFE_MODE_IMAGE_NAME" -f "$SAFE_MODE_DOCKERFILE" . || {
            echo -e "${RED}Docker build failed${LOG_COLOR_NC}"
            exit 1
        }
        echo -e "${GREEN}Image built successfully${LOG_COLOR_NC}"
    else
        echo -e "${CYAN}Using cached image: $SAFE_MODE_IMAGE_NAME${LOG_COLOR_NC}"
    fi
}

# Get appropriate Docker base image for detected tech stack
get_base_image() {
    if [[ -f "package.json" ]]; then
        echo "node:22-bookworm"
    elif [[ -f "requirements.txt" ]] || [[ -f "pyproject.toml" ]]; then
        echo "python:3.12-bookworm"
    elif [[ -f "Cargo.toml" ]]; then
        echo "rust:1-bookworm"
    elif [[ -f "go.mod" ]]; then
        echo "golang:1.23-bookworm"
    elif [[ -f "composer.json" ]]; then
        echo "php:8.4-cli-bookworm"
    elif [[ -f "pubspec.yaml" ]]; then
        echo "dart:stable"
    else
        # Default to Node as it includes npm for Claude Code
        echo "node:22-bookworm"
    fi
}

# Generate Dockerfile for safe mode
generate_dockerfile() {
    local base_image=$(get_base_image)

    mkdir -p "$PROJECT_ZHIREN_DIR"

    cat > "$SAFE_MODE_DOCKERFILE" << EOF
# Auto-generated by zhiren init --safe
# Modify as needed, then run: zhiren --rebuild

FROM $base_image

# Install Node.js if not present (needed for Claude Code CLI)
RUN command -v node >/dev/null 2>&1 || { \\
    apt-get update && apt-get install -y nodejs npm && rm -rf /var/lib/apt/lists/*; \\
}

# Install Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

# Install common dev tools
RUN apt-get update && apt-get install -y git curl && rm -rf /var/lib/apt/lists/*

# Create non-root user (Claude Code refuses --dangerously-skip-permissions as root)
# Make home directory world-writable so any UID can write (container is sandboxed anyway)
RUN useradd -m -s /bin/bash zhiren && \\
    mkdir -p /workspace && chown zhiren:zhiren /workspace && \\
    mkdir -p /home/zhiren/.claude && \\
    chmod -R 777 /home/zhiren
USER zhiren

WORKDIR /workspace
EOF

    echo -e "  - Generated $SAFE_MODE_DOCKERFILE (base: $base_image)"
}

# Get volume mount for tech-specific dependencies
get_dep_volume() {
    local project_name="$SAFE_MODE_PROJECT_NAME"

    if [[ -f "package.json" ]]; then
        echo "${project_name}-node-modules:/workspace/node_modules"
    elif [[ -f "requirements.txt" ]] || [[ -f "pyproject.toml" ]]; then
        echo "${project_name}-venv:/workspace/.venv"
    elif [[ -f "Cargo.toml" ]]; then
        echo "${project_name}-target:/workspace/target"
    elif [[ -f "go.mod" ]]; then
        echo "${project_name}-gopath:/go"
    elif [[ -f "composer.json" ]]; then
        echo "${project_name}-vendor:/workspace/vendor"
    else
        echo ""
    fi
}

export SAFE_MODE_DOCKERFILE
export SAFE_MODE_IMAGE_NAME

export -f detect_safe_mode
export -f build_docker_image
export -f generate_dockerfile
export -f get_dep_volume